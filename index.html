<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XKulverse - SMAN 1 Dramaga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tambahkan Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        .btn-primary {
            background-color: #e94560;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #f0627a;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
        }
        .input-field {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .input-field:focus {
            outline: none;
            border-color: #e94560;
            box-shadow: 0 0 0 2px rgba(233, 69, 96, 0.5);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }
        ::-webkit-scrollbar-thumb {
            background: #e94560;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #f0627a;
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="container mx-auto p-4 min-h-screen flex flex-col items-center justify-center">

        <!-- Page 1: Login -->
        <div id="loginPage" class="w-full max-w-md text-center">
            <div class="glassmorphism p-8 shadow-lg">
                <h1 class="text-4xl font-bold mb-2 text-white">XKulverse üöÄ</h1>
                <p class="text-gray-400 -mt-2 mb-6">Eskul SMAN 1 Dramaga</p>
                <p class="text-gray-300 mb-8">Daftar & kelola kegiatan ekstrakurikuler kamu.</p>
                <div class="space-y-6">
                    <input id="studentName" type="text" placeholder="Ketik nama lengkap kamu..." class="w-full p-4 rounded-lg input-field text-white placeholder-gray-400">
                    <button id="loginBtn" class="w-full p-4 rounded-lg btn-primary font-bold text-white text-lg">Masuk ‚ú®</button>
                </div>
                 <p id="loginError" class="text-red-400 mt-4 text-sm hidden">Nama tidak boleh kosong!</p>
            </div>
        </div>

        <!-- Main Content (Hidden by default) -->
        <div id="mainContent" class="hidden w-full h-full">
            <!-- Header -->
            <header class="glassmorphism p-4 mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-white">XKulverse ‚ú®</h1>
                    <p class="text-xs text-gray-400">SMAN 1 Dramaga</p>
                    <p class="text-gray-300 text-sm mt-2">üëã Selamat datang, <span id="welcomeName" class="font-semibold"></span>!</p>
                </div>
                <button id="logoutBtn" class="flex items-center gap-2 text-sm text-gray-300 hover:text-white transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Keluar
                </button>
            </header>

            <!-- Navigation -->
            <nav class="glassmorphism p-2 mb-6 flex justify-around rounded-full">
                <button data-page="homePage" class="nav-btn active p-3 rounded-full transition-all duration-300">
                    <i data-lucide="home" class="w-6 h-6"></i>
                </button>
                <button data-page="portfolioPage" class="nav-btn p-3 rounded-full transition-all duration-300">
                    <i data-lucide="award" class="w-6 h-6"></i>
                </button>
                <button data-page="forumPage" class="nav-btn p-3 rounded-full transition-all duration-300">
                    <i data-lucide="messages-square" class="w-6 h-6"></i>
                </button>
            </nav>
            
            <main>
                <!-- Page 2: Home (Ekskul List, Jadwal, Pengumuman) -->
                <div id="homePage" class="page-content">
                    
                    <div id="myEkskulSection" class="mb-8">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="user-check" class="w-5 h-5"></i>Ekskul Terdaftar Saya</h2>
                        <div id="myEkskulList" class="space-y-4">
                           <!-- My Registered Ekskul cards will be injected by JS -->
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h2 class="text-xl font-bold mb-3 flex items-center gap-2"><i data-lucide="megaphone" class="w-5 h-5"></i>Pengumuman & Informasi üì¢</h2>
                        <div id="announcement" class="glassmorphism p-4 text-sm">
                            <!-- Announcement content will be injected by JS -->
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="layout-grid" class="w-5 h-5"></i>Pilihan Ekstrakurikuler ‚ú®</h2>
                    <div id="ekskulList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Ekskul cards will be injected by JS -->
                    </div>
                </div>

                <!-- Page 3: Prestasi & Portofolio -->
                <div id="portfolioPage" class="page-content hidden">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="award" class="w-5 h-5"></i>Prestasi & Portofolio üèÜ</h2>
                    <div class="mb-4">
                        <select id="portfolioFilter" class="w-full p-3 rounded-lg input-field text-white">
                            <!-- Options will be injected by JS -->
                        </select>
                    </div>
                    <div id="portfolioContent" class="glassmorphism p-4 min-h-[300px]">
                        <!-- Portfolio content will be injected by JS -->
                    </div>
                     <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-3">Upload Laporan & Dokumentasi üìé</h3>
                        <div class="glassmorphism p-4 flex flex-col gap-4">
                            <input type="file" id="fileUpload" accept="image/*" class="text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200">
                            <textarea id="fileDescription" rows="3" placeholder="Deskripsi singkat..." class="w-full p-3 rounded-lg input-field text-white placeholder-gray-400"></textarea>
                            <button id="uploadBtn" data-action="uploadPortfolio" class="self-start px-6 py-2 rounded-lg btn-primary font-bold text-white text-sm">Upload üì§</button>
                        </div>
                    </div>
                </div>

                <!-- Page 4: Forum Diskusi -->
                <div id="forumPage" class="page-content hidden">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="messages-square" class="w-5 h-5"></i>Forum Diskusi üí¨</h2>
                    <div class="glassmorphism flex flex-col h-[60vh]">
                        <div id="chatBox" class="flex-1 p-4 overflow-y-auto space-y-4">
                            <!-- Chat messages will be injected by JS -->
                        </div>
                        <div id="typingIndicator" class="hidden px-4 pb-2 text-sm text-gray-400 italic">
                            XKul Bot sedang mengetik...
                        </div>
                        <div class="p-4 border-t border-gray-700 flex gap-3">
                            <input id="chatInput" type="text" placeholder="Ketik pesan..." class="flex-1 p-3 rounded-full input-field text-white placeholder-gray-400">
                            <button id="sendChatBtn" class="w-12 h-12 flex items-center justify-center rounded-full btn-primary">
                                <i data-lucide="send" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="ekskulModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
            <div id="modalContent" class="glassmorphism w-full max-w-lg p-6 relative transform transition-all scale-95 opacity-0"></div>
        </div>

        <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- KONEKSI SUPABASE ---
        // GANTI DENGAN URL DAN KUNCI API DARI PROYEK SUPABASE KAMU
        const SUPABASE_URL = 'https://obuaurtyjxluahtmggoh.supabase.co'; // CONTOH: https://abcdefg.supabase.co
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9idWF1cnR5anhsdWFodG1nZ29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MzE1NjQsImV4cCI6MjA3NjUwNzU2NH0.UDPjHlqSssXrFUhM0Ln8IuOPU1JOa3mFCes-xk4GzYg'; // CONTOH: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- UI ELEMENTS ---
        const loginPage = document.getElementById('loginPage');
        const mainContent = document.getElementById('mainContent');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const studentNameInput = document.getElementById('studentName');
        const loginError = document.getElementById('loginError');
        const welcomeName = document.getElementById('welcomeName');
        
        // --- GLOBAL STATE ---
        let currentUser = null;
        let myRegistrations = [];
        let ekskuls = [];
        let allPortfolios = {};
        let chats = [];
        
        const staticEkskuls = [
            { id: 1, name: "Basket", icon: "basketball", schedule: "Selasa & Jumat, 15:30" },
            { id: 2, name: "Futsal", icon: "soccer-ball", schedule: "Rabu & Sabtu, 15:30" },
            { id: 3, name: "Paskibra", icon: "flag", schedule: "Senin & Kamis, 15:00" },
            { id: 4, name: "PMR", icon: "heart-pulse", schedule: "Rabu, 15:00" },
            { id: 5, name: "Pramuka", icon: "compass", schedule: "Sabtu, 14:00" },
            { id: 6, name: "Teater", icon: "drama", schedule: "Kamis, 16:00" },
            { id: 7, name: "Musik", icon: "music", schedule: "Jumat, 16:00" },
            { id: 8, name: "Fotografi", icon: "camera", schedule: "Selasa, 16:00" },
            { id: 9, name: "KIR", icon: "flask-conical", schedule: "Rabu, 15:30" },
            { id: 10, name: "E-Sport", icon: "gamepad-2", schedule: "Sabtu, 16:00" },
            { id: 11, name: "Jurnalistik", icon: "newspaper", schedule: "Senin, 15:30" },
            { id: 12, name: "Tari", icon: "person-standing", schedule: "Kamis, 15:30" },
            { id: 13, name: "Band", icon: "guitar", schedule: "Jumat, 16:30" },
        ];
        
        // --- DATA FUNCTIONS (SUPABASE) ---
        
        async function loadInitialData() {
            try {
                // Fetch user's registrations
                const { data: regs, error: regsError } = await supabaseClient
                    .from('registrations')
                    .select('*')
                    .eq('student_name', currentUser);
                if (regsError) throw regsError;
                myRegistrations = regs;

                // Fetch all portfolios and group by ekskul_id
                const { data: portfoliosData, error: portfoliosError } = await supabaseClient
                    .from('portfolios')
                    .select('*');
                if (portfoliosError) throw portfoliosError;
                allPortfolios = portfoliosData.reduce((acc, item) => {
                    if (!acc[item.ekskul_id]) acc[item.ekskul_id] = [];
                    acc[item.ekskul_id].push(item);
                    return acc;
                }, {});

                // Fetch all ekskuls with member counts
                const { data: allRegs, error: allRegsError } = await supabaseClient
                    .from('registrations')
                    .select('ekskul_id');
                if (allRegsError) throw allRegsError;

                const memberCounts = allRegs.reduce((acc, reg) => {
                    acc[reg.ekskul_id] = (acc[reg.ekskul_id] || 0) + 1;
                    return acc;
                }, {});

                ekskuls = staticEkskuls.map(e => ({ ...e, members: memberCounts[e.id] || 0 }));
                
            } catch (error) {
                console.error("Error loading data:", error);
                showToast(`Gagal memuat data: ${error.message}`, 'error');
            }
        }
        
        async function loadChats() {
            const { data, error } = await supabaseClient.from('chats').select('*').order('created_at', { ascending: true });
            if (error) {
                console.error('Error fetching chats:', error);
                return;
            }
            chats = data;
            renderChats();
        }

        function subscribeToChat() {
            supabaseClient.channel('public:chats')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chats' }, payload => {
                    chats.push(payload.new);
                    renderChats();
                })
                .subscribe();
        }

        // --- RENDER FUNCTIONS ---
        
        const renderEkskuls = () => {
            const listEl = document.getElementById('ekskulList');
            listEl.innerHTML = ekskuls.map(ekskul => {
                const isRegistered = myRegistrations.some(r => r.ekskul_id === ekskul.id);
                return `<div data-action="showEkskulDetails" data-id="${ekskul.id}" class="glassmorphism p-4 text-center cursor-pointer flex flex-col items-center justify-center aspect-square"><div class="pointer-events-none"><i data-lucide="${ekskul.icon}" class="w-10 h-10 mb-2 ${isRegistered ? 'text-pink-400' : 'text-white'}"></i><h3 class="font-semibold">${ekskul.name}</h3><p class="text-xs text-gray-400">${ekskul.members || 0} anggota</p>${isRegistered ? '<span class="text-xs mt-2 bg-pink-500/30 text-pink-300 px-2 py-1 rounded-full">Terdaftar</span>' : ''}</div></div>`;
            }).join('');
            lucide.createIcons();
        };
        
        const renderMyEkskuls = () => {
             const listEl = document.getElementById('myEkskulList');
            if (myRegistrations.length === 0) {
                listEl.innerHTML = `<div class="glassmorphism p-4 text-center text-gray-400">Kamu belum mendaftar di ekskul manapun.</div>`;
                return;
            }
            listEl.innerHTML = myRegistrations.map(reg => {
                const ekskul = ekskuls.find(e => e.id === reg.ekskul_id);
                if (!ekskul) return '';
                return `<div class="glassmorphism p-4 rounded-lg flex items-center gap-4">
                    <i data-lucide="${ekskul.icon}" class="w-10 h-10 text-pink-400"></i>
                    <div>
                        <h3 class="font-bold text-lg">${ekskul.name}</h3>
                        <p class="text-sm text-gray-400">Jadwal: ${ekskul.schedule}</p>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        };
        
        const renderPortfolio = () => {
            const filter = document.getElementById('portfolioFilter');
            const contentEl = document.getElementById('portfolioContent');
            const selectedId = parseInt(filter.value);
            const items = allPortfolios[selectedId] || [];

            if (items.length > 0) {
                contentEl.innerHTML = items.map(item => `
                    <div class="mb-4 pb-4 border-b border-gray-700 last:border-b-0">
                        <p class="font-bold text-white">${item.achievement}</p>
                        <p class="text-sm text-gray-300">Oleh: ${item.student_name}</p>
                        <p class="text-sm text-gray-400 mt-1">"${item.description}"</p>
                    </div>
                `).join('');
            } else {
                contentEl.innerHTML = `<p class="text-gray-400 text-center mt-8">Belum ada portofolio. üìÇ</p>`;
            }
        };

        const populatePortfolioFilter = () => {
            const filter = document.getElementById('portfolioFilter');
            filter.innerHTML = `<option value="0" disabled selected>-- Pilih Ekstrakurikuler --</option>`;
            staticEkskuls.forEach(ekskul => {
                filter.innerHTML += `<option value="${ekskul.id}">${ekskul.name}</option>`;
            });
        };

        const renderChats = () => {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = chats.map(chat => {
                const isCurrentUser = chat.user_name === currentUser;
                return `
                <div class="flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'}">
                    <div class="text-xs text-gray-400 mb-1 ${isCurrentUser ? 'mr-2' : 'ml-2'}">${chat.user_name} - ${chat.time}</div>
                    <div class="max-w-xs md:max-w-md p-3 rounded-2xl ${isCurrentUser ? 'bg-pink-600 text-white rounded-br-none' : 'glassmorphism rounded-bl-none'}">
                       ${chat.message}
                    </div>
                </div>`;
            }).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        };
        
        // --- EVENT HANDLERS & ACTIONS ---
        
        document.body.addEventListener('click', async (e) => {
            const action = e.target.dataset.action || e.target.closest('[data-action]')?.dataset.action;
            const id = e.target.dataset.id || e.target.closest('[data-id]')?.dataset.id;

            switch(action) {
                case 'showEkskulDetails':
                    showEkskulDetailsModal(id);
                    break;
                case 'closeModal':
                    closeModal();
                    break;
                case 'register':
                    await registerEkskul(id);
                    break;
                case 'unregister':
                    await unregisterEkskul(id);
                    break;
                case 'uploadPortfolio':
                    await uploadPortfolio();
                    break;
            }
        });

        const showEkskulDetailsModal = (id) => {
            const modal = document.getElementById('ekskulModal');
            const content = document.getElementById('modalContent');
            const ekskul = ekskuls.find(e => e.id == id);
            const isRegistered = myRegistrations.some(r => r.ekskul_id == id);

            content.innerHTML = `
                <button data-action="closeModal" class="absolute top-2 right-4 text-2xl text-gray-400 hover:text-white">&times;</button>
                <div class="text-center">
                    <i data-lucide="${ekskul.icon}" class="w-16 h-16 mx-auto mb-4 text-pink-400"></i>
                    <h2 class="text-2xl font-bold">${ekskul.name}</h2>
                    <p class="text-gray-400 mb-4">${ekskul.members || 0} anggota terdaftar</p>
                    <p class="mb-6">Jadwal: ${ekskul.schedule}</p>
                </div>
                <button data-action="${isRegistered ? 'unregister' : 'register'}" data-id="${id}" class="${isRegistered ? 'bg-red-600' : 'btn-primary'} w-full p-3 rounded-lg font-bold text-white">${isRegistered ? 'Batalkan Pendaftaran' : 'Daftar'}</button>
            `;
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('scale-95', 'opacity-0'), 10);
            lucide.createIcons();
        };
        
        const closeModal = () => {
            const modal = document.getElementById('ekskulModal');
            const content = document.getElementById('modalContent');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        async function registerEkskul(ekskulId) {
            try {
                const { error } = await supabaseClient.from('registrations').insert({
                    student_name: currentUser,
                    ekskul_id: ekskulId,
                    streak: 0
                });
                if (error) throw error;
                showToast('Berhasil mendaftar!', 'success');
                await loadInitialData(); // Reload data
                renderAll();
                closeModal();
            } catch (error) {
                showToast(`Gagal mendaftar: ${error.message}`, 'error');
            }
        }
        
        async function unregisterEkskul(ekskulId) {
             try {
                const { error } = await supabaseClient
                    .from('registrations')
                    .delete()
                    .match({ student_name: currentUser, ekskul_id: ekskulId });
                if (error) throw error;
                showToast('Pendaftaran dibatalkan.', 'info');
                await loadInitialData(); // Reload data
                renderAll();
                closeModal();
            } catch (error) {
                showToast(`Gagal batal mendaftar: ${error.message}`, 'error');
            }
        }

        async function uploadPortfolio() {
            const fileInput = document.getElementById('fileUpload');
            const description = document.getElementById('fileDescription').value.trim();
            const ekskulId = document.getElementById('portfolioFilter').value;

            if (!ekskulId || !description || fileInput.files.length === 0) {
                showToast('Harap lengkapi semua data!', 'error');
                return;
            }

            // Di aplikasi nyata, kita akan upload file ke Supabase Storage.
            // Untuk sekarang, kita simpan datanya saja.
            try {
                const { error } = await supabaseClient.from('portfolios').insert({
                    student_name: currentUser,
                    ekskul_id: ekskulId,
                    achievement: `Dokumentasi: ${fileInput.files[0].name}`,
                    description: description,
                    image_url: 'placeholder.jpg' // Placeholder
                });
                if (error) throw error;
                showToast('Portofolio berhasil diupload!', 'success');
                await loadInitialData();
                renderPortfolio();
                fileInput.value = '';
                document.getElementById('fileDescription').value = '';
            } catch (error) {
                showToast(`Gagal upload: ${error.message}`, 'error');
            }
        }

        async function handleSendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            try {
                const { error } = await supabaseClient.from('chats').insert({
                    user_name: currentUser,
                    message: message,
                    time: time
                });
                if (error) throw error;
                input.value = '';
            } catch (error) {
                showToast(`Gagal mengirim pesan: ${error.message}`, 'error');
            }
        }
        
        // --- UTILS & HELPERS ---
        const showToast = (message, type = 'success') => {
            const el = document.getElementById('toast');
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'info') bgColor = 'bg-blue-500';
            el.textContent = message;
            el.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg transform transition-all duration-300 ${bgColor} translate-y-0 opacity-100`;
            setTimeout(() => {
                el.className = el.className.replace('translate-y-0 opacity-100', 'translate-y-20 opacity-0');
            }, 3000);
        };
        
        const switchPage = (pageId) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
                btn.classList.toggle('bg-pink-500/30', btn.dataset.page === pageId);
                btn.classList.toggle('text-pink-300', btn.dataset.page === pageId);
            });
        };
        
        async function handleLogin() {
            const name = studentNameInput.value.trim();
            if (!name) {
                loginError.classList.remove('hidden');
                return;
            }
            currentUser = name;
            localStorage.setItem('xkulverse_currentUser', currentUser);

            try {
                // Check if user exists
                let { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('student_name')
                    .eq('student_name', currentUser)
                    .single(); // .single() expects one row
                
                // If user doesn't exist, create one
                if (!profile) {
                    const { error: insertError } = await supabaseClient.from('profiles').insert({ student_name: currentUser });
                    if (insertError) throw insertError;
                }
                
                loginPage.classList.add('hidden');
                mainContent.classList.remove('hidden');
                welcomeName.textContent = currentUser;
                await initApp();

            } catch(error) {
                showToast(`Login gagal: ${error.message}`, 'error');
                localStorage.removeItem('xkulverse_currentUser');
                currentUser = null;
            }
        }
        
        function handleLogout() {
            localStorage.removeItem('xkulverse_currentUser');
            currentUser = null;
            mainContent.classList.add('hidden');
            loginPage.classList.remove('hidden');
            studentNameInput.value = '';
        }
        
        function renderAll() {
            renderMyEkskuls();
            renderEkskuls();
            renderPortfolio();
        }

        // --- APP INITIALIZATION ---
        async function initApp() {
            switchPage('homePage');
            await loadInitialData();
            await loadChats();
            renderAll();
            populatePortfolioFilter();
            subscribeToChat();
            lucide.createIcons();
            document.getElementById('announcement').innerHTML = `<p>Pengumuman akan ditampilkan di sini.</p>`; // Placeholder
        }

        // --- Event Listeners Setup ---
        loginBtn.addEventListener('click', handleLogin);
        studentNameInput.addEventListener('keyup', (e) => e.key === 'Enter' && handleLogin());
        logoutBtn.addEventListener('click', handleLogout);
        document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => switchPage(btn.dataset.page)));
        document.getElementById('portfolioFilter').addEventListener('change', renderPortfolio);
        document.getElementById('sendChatBtn').addEventListener('click', handleSendMessage);
        document.getElementById('chatInput').addEventListener('keyup', (e) => e.key === 'Enter' && handleSendMessage());
        
        // Check for saved user on page load
        const savedUser = localStorage.getItem('xkulverse_currentUser');
        if (savedUser) {
            studentNameInput.value = savedUser;
            handleLogin();
        }
    });
    </script>
</body>
</html>
